# Prometheus

# Step1 admin-user
```
add my user to as admin
kubect create -f admin-user.yaml
```

# Step2 prometheus-operator
```
https://github.com/coreos/prometheus-operator
The Prometheus Operator for Kubernetes provides easy monitoring definitions for Kubernetes services and deployment and management of Prometheus instances.
Once installed, the Prometheus Operator provides the following features:

Create/Destroy: Easily launch a Prometheus instance for your Kubernetes namespace, a specific application or team easily using the Operator.

Simple Configuration: Configure the fundamentals of Prometheus like versions, persistence, retention policies, and replicas from a native Kubernetes resource.

Target Services via Labels: Automatically generate monitoring target configurations based on familiar Kubernetes label queries; no need to learn a Prometheus specific configuration language.



Deployment
image: quay.io/coreos/prometheus-operator:v0.16.1
serviceAccountName: prometheus-operator
kubectl create -f premetheus-operator.yaml
kubectl get ServiceAccount
NAME                  SECRETS   AGE
prometheus-operator   1         52s
hamedh-mv-ltmp-x:premetheus-kubernetes hamedh$ kubectl get deployments
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
prometheus-operator   1         1         1            1           1m
```


# step 3 monitor kube-scheduler and kube-controller-manager
```
Aside from the kubelet and the API server the other Kubernetes components all run on top of Kubernetes itself. To discover Kubernetes components that run in a Pod, they simply have to be added to a Service.
namespace: kube-system
kubectl create -f kube-scheduler.yaml
kubectl create -f kube-controller-manager.yaml

kubectl get svc --all-namespaces
NAMESPACE     NAME                                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
kube-system   kube-controller-manager-prometheus-discovery   ClusterIP   None            <none>        10252/TCP       18s
kube-system   kube-scheduler-prometheus-discovery            ClusterIP   None            <none>        10251/TCP       27s
```


# step 4 Node Exporters
```
Unrelated to Kubernetes itself, but still important is to gather various metrics about the actual nodes. Typical metrics are CPU, memory, disk and network utilization, all of these metrics can be gathered using the node_exporter

DaemonSet
serviceAccountName: node-exporter
name: node-exporter
- image: quay.io/prometheus/node-exporter:v0.15.2
- "--web.listen-address=127.0.0.1:9101"


The kube-rbac-proxy is a small HTTP proxy for a single upstream, that can perform RBAC authorization against the Kubernetes API using SubjectAccessReviews.
name: kube-rbac-proxy
- image: quay.io/brancz/kube-rbac-proxy:v0.2.0

kubectl create -f node-exporter-rbac.yaml
kubectl get serviceaccount
NAME                  SECRETS   AGE
node-exporter         1         55s

kubectl create -f node-exporter.yaml
kubectl get svc
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
node-exporter   ClusterIP   None          <none>        9100/TCP   14s
kubectl get ds
NAME            DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
node-exporter   3         3         3         3            3           <none>          1m
```

# Step 5 Kube State Metrics
```
kube-state-metrics which collects information about Kubernetes objects themselves as they are accessible from the API
It is not focused on the health of the individual Kubernetes components, but rather on the health of the various objects inside, such as deployments, nodes and pods.

kube-state-metrics vs. Heapster
Heapster is a project which fetches metrics (such as CPU and memory utilization) from the Kubernetes API server and nodes and sends them to various time-series backends such as InfluxDB or Google Cloud Monitoring. Its most important function right now is implementing certain metric APIs that Kubernetes components like the horizontal pod auto-scaler query to make decisions.

While Heapster's focus is on forwarding metrics already generated by Kubernetes, kube-state-metrics is focused on generating completely new metrics from Kubernetes' object state (e.g. metrics based on deployments, replica sets, etc.). The reason not to extend Heapster with kube-state-metrics' abilities is because the concerns are fundamentally different: Heapster only needs to fetch, format and forward metrics that already exist, in particular from Kubernetes components, and write them into sinks, which are the actual monitoring systems. kube-state-metrics, in contrast, holds an entire snapshot of Kubernetes state in memory and continuously generates new metrics based off of it but has no responsibility for exporting its metrics anywhere.


Deployment
serviceAccountName: kube-state-metrics

# RBAC
kubectl create -f kube-state-metrics-rbac.yaml
kubectl get serviceaccount
NAME                  SECRETS   AGE
kube-state-metrics    1         17s

kubectl create -f kube-state-metrics.yaml
kubectl get deployments
NAME                  DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kube-state-metrics    1         1         1            1           6s
kubectl get svc
NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)             AGE
kube-state-metrics   ClusterIP   None          <none>        8443/TCP,9443/TCP   19s
```



# Step 6 Actual Prometheus
```
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
serviceAccountName: prometheus-k8s

namespace: monitoring

# RBAC
kubectl create -f prometheus-rbac.yaml
kubectl get serviceaccount
NAME                  SECRETS   AGE
prometheus-k8s        1         21s

kubectl create -f prometheus.yaml
kubectl get Prometheus
NAME      AGE
k8s       17s
```

# step 7 setup monitoring
```
kubectl create -f kubernetes-monitoring.yaml
servicemonitor "kube-apiserver" created
servicemonitor "kubelet" created
servicemonitor "kube-controller-manager" created
servicemonitor "kube-scheduler" created
servicemonitor "kube-state-metrics" created
servicemonitor "node-exporter" created
hamedh-mv-ltmp-x:premetheus-kubernetes hamedh$ kubectl get servicemonitor
NAME                      AGE
kube-apiserver            4s
kube-controller-manager   3s
kube-scheduler            3s
kube-state-metrics        3s
kubelet                   4s
node-exporter             3s
```

# step 8 alert manager
```
kubectl create -f alertmanager.yaml
```

# create LoadBalancer for prometheus Or better option create Ingress
```
kubectl create -f prometheus-loadbalancer.yaml
kubectl create -f prometheus-Ingress.yaml

```
